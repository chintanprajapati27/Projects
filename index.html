<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleek Break Tracker - Digital Clock</title>
    <style>
        /* Midnight Sky Color Palette */
        :root {
            --color-background: #0d1b2a; /* Deep Indigo/Navy */
            --color-panel: #1b263b;      /* Slightly Lighter Indigo */
            --color-card: #283747;       /* Dark Blue Gray for contrast */
            --color-primary: #415a77;    /* Slate Blue for borders/accents */
            --color-secondary: #e0fbfc;  /* Light Cyan for primary text */
            --color-timer: #00bcd4;      /* Electric Cyan for timer */
            --color-success: #4ade80;    /* Vibrant Green for Start */
            --color-error: #f87171;      /* Coral Red for Stop */
        }

        /* BASE & TYPOGRAPHY */
        /* Changed to Share Tech Mono for digital look */
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body {
            font-family: 'Share Tech Mono', monospace; /* Digital font applied here */
            background-color: var(--color-background);
            margin: 0;
            padding: 0;
            height: 100vh; 
            overflow: hidden; /* Prevent body scrolling on desktop */
            color: var(--color-secondary);
        }

        /* UTILITY CLASSES */
        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .p-4 { padding: 1rem; }
        .p-6 { padding: 1.5rem; }
        .rounded-2xl { border-radius: 1rem; }
        .shadow-3xl { box-shadow: 0 0 40px rgba(0, 0, 0, 0.5); }
        .text-white { color: var(--color-secondary); }
        .text-light-blue { color: var(--color-timer); }
        .font-bold { font-weight: 700; }
        .font-extrabold { font-weight: 900; }
        .transition-all { transition: all 0.3s ease-in-out; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .space-y-6 > * + * { margin-top: 1.5rem; }

        /* INPUT STYLES */
        .input-style {
            box-sizing: border-box; 
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-primary);
            border-radius: 0.5rem;
            font-size: 1.125rem;
            color: var(--color-secondary);
            background-color: var(--color-panel);
            outline: none;
            /* Monospace font applied via body, but ensure consistency */
            font-family: 'Share Tech Mono', monospace;
        }
        .input-style:focus {
            border-color: var(--color-timer);
            box-shadow: 0 0 0 3px rgba(0, 188, 212, 0.5);
        }

        /* BUTTON STYLES */
        .btn-base {
            padding: 1rem 1.5rem;
            font-size: 1.25rem;
            border-radius: 0.75rem;
            cursor: pointer;
            border: none;
            color: var(--color-background);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.4);
            transform: scale(1);
        }
        .btn-base:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.6);
        }
        .btn-start {
            background: linear-gradient(135deg, var(--color-success), #279f53); 
        }
        .btn-stop {
            background: linear-gradient(135deg, var(--color-error), #d14646); 
        }
        .btn-base:active { 
            transform: scale(0.98); 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        }
        .disabled-style:disabled { 
            opacity: 0.4; 
            cursor: not-allowed; 
            box-shadow: none;
            transform: none;
        }

        /* TIME CARD STYLES */
        .time-card {
            background: var(--color-card); 
            border: 2px solid var(--color-primary);
            color: var(--color-secondary);
            padding: 2rem;
            border-radius: 1.5rem;
            text-align: center;
        }
        
        /* Dynamic Time Font Size */
        .time-text {
            font-size: 10vw; 
            font-weight: 400; /* Share Tech Mono only has one weight */
            letter-spacing: 0.1em; /* Increased spacing for better digital look */
            color: var(--color-timer);
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.5);
            margin-top: 1rem;
        }
        
        /* LOGS STYLES */
        .logs-panel {
            background-color: var(--color-panel); 
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        .log-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto; 
            flex-grow: 1; 
        }
        .log-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #3c516d; /* Slightly darker shade for separation */
        }
        .log-item:nth-child(even) {
            background-color: #24344d; /* Subtle alternate row shading */
        }
        .log-item-time { color: var(--color-success); font-weight: 400; font-size: 1rem; }

        /* MESSAGE BOX */
        .message-box {
            position: fixed;
            bottom: 1.5rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 400;
            z-index: 1000;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            opacity: 1;
            visibility: visible;
        }
        .message-success { background-color: var(--color-success); color: var(--color-background); }
        .message-error { background-color: var(--color-error); color: var(--color-background); }

        /* --- DESKTOP LAYOUT (Default) --- */
        .main-flex {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            height: 100%; 
            box-sizing: border-box;
        }
        
        .left-panel {
            flex: 2; 
            display: flex;
            flex-direction: column;
        }

        .right-panel {
            flex: 1.5; 
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            min-width: 300px; 
        }
        
        .time-card {
            flex-grow: 1; 
        }

        .logs-container {
            flex: 1; 
            min-height: 200px; 
        }
        .button-group {
            display: flex;
            gap: 1rem;
            width: 100%;
        }

        /* --- MOBILE LAYOUT (Media Query for 900px or narrower screens) --- */
        @media (max-width: 900px) {
            .main-flex {
                flex-direction: column; 
                height: auto; 
                padding: 1rem;
            }
            body {
                overflow-y: auto; /* Allow body scrolling only on small screens for stacked content */
            }
            .time-card {
                min-height: 25vh;
            }
            .time-text {
                font-size: 16vw; /* Increase font size a bit for better mobile viewing */
            }
            .logs-container {
                min-height: 300px; 
            }
            .button-group {
                flex-direction: column; 
                gap: 0.75rem;
            }
        }
    </style>
</head>
<body>

    <!-- Main Container -->
    <div class="main-flex shadow-3xl">

        <!-- Left Panel: Time Tracker Card (Large, Dynamic) -->
        <div class="left-panel">
            <div class="time-card flex flex-col justify-center items-center">
                <h1 class="text-3xl font-extrabold mb-4">Live Break Status</h1>
                <p class="text-xl font-semibold opacity-80" style="opacity: 0.8;">Total Break Duration Today</p>
                <p id="totalTime" class="time-text">00:00:00</p>
            </div>
        </div>


        <!-- Right Panel: Controls and Logs -->
        <div class="right-panel">
            
            <!-- Input Card -->
            <div class="p-6 rounded-2xl shadow-3xl space-y-4" style="background-color: var(--color-panel);">
                <h2 class="text-xl font-bold text-light-blue">Employee Details</h2>
                <input type="text" id="employeeNameInput" placeholder="Enter Employee Name" class="input-style w-full transition-all">
            </div>

            <!-- Action Buttons -->
            <div class="button-group">
                <button id="punchInBtn" class="w-full btn-base btn-start font-bold transition-all">
                    BREAK START
                </button>
                <button id="punchOutBtn" class="w-full btn-base btn-stop font-bold transition-all disabled-style" disabled>
                    BREAK STOP
                </button>
            </div>

            <!-- Break Logs Section -->
            <div class="logs-container logs-panel shadow-3xl p-4">
                <h2 class="text-xl font-bold text-light-blue mb-3" style="border-bottom: 1px solid var(--color-primary); padding-bottom: 0.5rem;">Recent Logs</h2>
                <ul id="logList" class="log-list">
                    <!-- Break logs will be added here dynamically -->
                    <li class="p-4 text-center" style="color: #94a3b8;">No breaks recorded yet.</li>
                </ul>
            </div>

        </div>
    </div>

    <script>
        const employeeNameInput = document.getElementById('employeeNameInput');
        const punchInBtn = document.getElementById('punchInBtn');
        const punchOutBtn = document.getElementById('punchOutBtn');
        const totalTimeDisplay = document.getElementById('totalTime');
        const logList = document.getElementById('logList');

        // IMPORTANT: Use the Google Apps Script URL from the previous iteration or a valid one.
        // I am leaving the placeholder, but note it will display a warning message in the app.
        const appsScriptUrl = 'https://script.google.com/macros/s/AKfycbw21TUzjd1Nra5UL-GpEYOnJgb6IfI2cf6rZGFhv0_Fbo9oMOnA_g_y_z_zz_A/exec'; 

        let breaks = [];
        let punchInTime = null;
        let totalBreakTime = 0;
        let timerInterval = null;
        let lastAccessDate = null; 
        let fifteenMinuteBatchesCompleted = 0; 

        /**
         * Checks if a date is from today.
         */
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                   date.getMonth() === today.getMonth() &&
                   date.getFullYear() === today.getFullYear();
        }
        
        /**
         * Requests permission for browser notifications.
         */
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                console.warn("This browser does not support desktop notification");
            } else if (Notification.permission !== "granted") {
                Notification.requestPermission();
            }
        }

        /**
         * Helper function for ordinal numbers (1st, 2nd, 3rd, etc.)
         */
        function getOrdinal(n) {
            const s = ["th", "st", "nd", "rd"];
            const v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        /**
         * Sends a notification for a completed 15-minute break slot.
         */
        function sendBreakNotification(batchNumber) {
            const message = `Break Alert: Your ${batchNumber}${getOrdinal(batchNumber)} 15-minute slot is complete!`;
            
            // 1. In-app Message
            showMessage(message, 'success');

            // 2. Browser Notification
            if (Notification.permission === "granted") {
                new Notification("Break Tracker", {
                    body: message,
                    icon: 'https://placehold.co/60x60/4ade80/0d1b2a?text=15M' 
                });
            }
        }

        // Load state from localStorage on page load
        document.addEventListener('DOMContentLoaded', () => {
            requestNotificationPermission(); 
            
            const savedState = localStorage.getItem('breakTrackerState');
            let employeeName = '';

            if (savedState) {
                const state = JSON.parse(savedState);
                
                // --- Daily Reset Logic ---
                if (state.lastAccessDate) {
                    const savedDate = new Date(state.lastAccessDate);
                    employeeName = state.employeeName || ''; 

                    if (!isToday(savedDate)) {
                        // New day, reset state
                        breaks = [];
                        totalBreakTime = 0;
                        punchInTime = null;
                        fifteenMinuteBatchesCompleted = 0;
                        showMessage('New Day Detected: Break logs and total time have been reset.', 'success');
                    } else {
                        // Same day, load all previous data
                        breaks = state.breaks;
                        totalBreakTime = state.totalBreakTime;
                        punchInTime = state.punchInTime ? new Date(state.punchInTime) : null;
                        
                        if (punchInTime) {
                            const timeSinceBreakStart = (new Date() - punchInTime) / 1000;
                            fifteenMinuteBatchesCompleted = Math.floor(timeSinceBreakStart / 900);
                        } else {
                            fifteenMinuteBatchesCompleted = 0;
                        }
                    }
                }
                
                employeeNameInput.value = employeeName || ''; 
            }

            lastAccessDate = new Date();
            saveState(); 

            renderLogs();
            updateTotalTimeDisplay();

            if (punchInTime) {
                startTimer();
            }
            updateButtonState();
        });

        function saveState() {
            const state = {
                breaks,
                totalBreakTime,
                employeeName: employeeNameInput.value,
                punchInTime: punchInTime ? punchInTime.toISOString() : null,
                lastAccessDate: lastAccessDate ? lastAccessDate.toISOString() : null
            };
            localStorage.setItem('breakTrackerState', JSON.stringify(state));
        }

        function updateButtonState() {
            if (punchInTime) {
                punchInBtn.disabled = true;
                punchOutBtn.disabled = false;
                punchInBtn.classList.add('disabled-style');
                punchOutBtn.classList.remove('disabled-style');
            } else {
                punchInBtn.disabled = false;
                punchOutBtn.disabled = true;
                punchInBtn.classList.remove('disabled-style');
                punchOutBtn.classList.add('disabled-style');
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            timerInterval = setInterval(() => {
                // Ensure punchInTime is still valid
                if (!punchInTime) {
                    clearInterval(timerInterval);
                    return;
                }
                
                const elapsed = (new Date() - punchInTime) / 1000;
                const newTotalTime = totalBreakTime + elapsed; 
                updateTotalTimeDisplay(newTotalTime);

                // --- 15 Minute Notification Logic ---
                const currentElapsedSincePunchIn = (new Date() - punchInTime) / 1000;
                const currentBatchCount = Math.floor(currentElapsedSincePunchIn / 900); 

                if (currentBatchCount > fifteenMinuteBatchesCompleted) {
                    fifteenMinuteBatchesCompleted = currentBatchCount;
                    sendBreakNotification(currentBatchCount);
                }
            }, 1000);
        }

        function updateTotalTimeDisplay(time = totalBreakTime) {
            const hours = Math.floor(time / 3600);
            const minutes = Math.floor((time % 3600) / 60);
            const seconds = Math.floor(time % 60);

            const format = (num) => num.toString().padStart(2, '0');
            totalTimeDisplay.textContent = `${format(hours)}:${format(minutes)}:${format(seconds)}`;
        }

        function renderLogs() {
            logList.innerHTML = '';
            if (breaks.length === 0) {
                logList.innerHTML = '<li class="p-4 text-center" style="color: #94a3b8;">No breaks recorded yet.</li>';
                return;
            }

            breaks.forEach((b, index) => {
                const li = document.createElement('li');
                li.className = 'log-item transition-all';
                
                const startTime = new Date(b.punchIn).toLocaleTimeString();
                const endTime = new Date(b.punchOut).toLocaleTimeString();
                const duration = formatDuration(b.duration);
                
                li.innerHTML = `
                    <div class="flex flex-col text-sm">
                        <span class="font-bold text-white">Break #${breaks.length - index}</span> 
                        <span class="text-xs" style="color: #a0a0c0;">From ${startTime} to ${endTime}</span>
                    </div>
                    <span class="log-item-time">${duration}</span>
                `;
                logList.prepend(li);
            });
        }

        function formatDuration(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function showMessage(message, type = 'error') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `message-box ${type === 'error' ? 'message-error' : 'message-success'} transition-all`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            
            // Auto-remove message after 4 seconds
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translate(-50%, 20px)';
                setTimeout(() => {
                     alertDiv.remove();
                }, 300); 
            }, 4000);
        }

        async function logPunchToServer(type) {
            const employeeName = employeeNameInput.value.trim();
            if (!employeeName) {
                showMessage('Please enter an employee name.', 'error');
                return;
            }
            
            const payload = {
                employeeName: employeeName,
                punchType: type === 'IN' ? 'BREAK START' : 'BREAK STOP',
                timestamp: new Date().toISOString(),
                source: 'WebApp'
            };

            const maxRetries = 3;
            let currentRetry = 0;
            
            while (currentRetry < maxRetries) {
                try {
                    // Check for placeholder URL to prevent unnecessary network calls to a non-functional endpoint
                    if (!appsScriptUrl || appsScriptUrl.includes('AKfycbw21TUzjd1Nra5UL-GpEYOnJgb6IfI2cf6rZGFhv0_Fbo9oMOnA_g_y_z_zz_A')) {
                        showMessage('Google Sheet URL is a placeholder. Data not sent.', 'error');
                        return;
                    }

                    const response = await fetch(appsScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors', 
                        cache: 'no-cache',
                        headers: {
                            'Content-Type': 'application/json', 
                        },
                        body: JSON.stringify(payload),
                    });
                    
                    if (currentRetry === 0) { 
                        showMessage(`Successfully logged ${payload.punchType} to Google Sheet!`, 'success');
                    }
                    return;

                } catch (error) {
                    console.error(`Attempt ${currentRetry + 1} failed:`, error);
                    currentRetry++;

                    if (currentRetry === maxRetries) {
                        showMessage(`Failed to connect to Google Sheet after ${maxRetries} tries.`, 'error');
                        return;
                    }

                    // Exponential backoff
                    const delay = Math.pow(2, currentRetry) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        employeeNameInput.addEventListener('input', saveState);

        punchInBtn.addEventListener('click', () => {
            const employeeName = employeeNameInput.value.trim();
            if (!employeeName) {
                showMessage('Please enter an employee name.', 'error');
                return;
            }

            if (!punchInTime) {
                punchInTime = new Date();
                logPunchToServer('IN'); 
                startTimer();
                updateButtonState();
                saveState();
            }
        });

        punchOutBtn.addEventListener('click', () => {
            if (punchInTime) {
                const punchOutTime = new Date();
                const duration = (punchOutTime - punchInTime) / 1000;
                breaks.push({
                    punchIn: punchInTime.toISOString(),
                    punchOut: punchOutTime.toISOString(),
                    duration: duration
                });
                totalBreakTime += duration;

                logPunchToServer('OUT');
                
                punchInTime = null;
                clearInterval(timerInterval);
                fifteenMinuteBatchesCompleted = 0; 
                renderLogs();
                updateTotalTimeDisplay();
                updateButtonState();
                saveState();
            }
        });
        
        updateButtonState();
    </script>
</body>
</html>
